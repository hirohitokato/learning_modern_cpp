# マルチスレッド

## 1.そもそもスレッドとは

プログラム中の１つの制御の流れのこと。CPUは１コアで１つの処理しか動かせないが、それを複数あるかのように仮想的に見せる仕組みや環境を表す。

スレッドは特定のプロセスに属する形で存在し、プロセスは複数のスレッドを保持・実行できる。スレッド間では親となるプロセスの情報を共有するが、スレッド間では独立した実行コンテキストを持つ。

* スレッドの実行コンテキスト：
    * スタック領域
    * レジスタセット(プログラムカウンタ、スタックポインタや各種汎用レジスタ)
    * スレッドローカル変数
    * 優先度などの属性

### 1.1.プロセスとスレッドの違い

端的に言うと、独立して持つ実行コンテキストの規模・レイヤーが異なる。

* プロセスの実行コンテキスト
    * 仮想アドレス空間
    * ファイル/ネットワーク/デバイスなどIOやリソースへのアクセス権

スレッドは上記を同一プロセス内で共有する。

* プロセスは独立した仮想アドレス空間を持つ
    * ⇔スレッドは同一プロセス(システム)内で仮想アドレス空間を共有する
* プロセスの方がスレッドよりも生成コスト・切替コストが大きい
    * ポインタの差し替えだけでなくCPUキャッシュクリアも含むため
    * 参考： https://naoya-2.hatenadiary.org/entry/20071010/1192040413

|スレッド|プロセス|
|---|---|
|プログラムカウンタ<br>スタック<br>汎用レジスタの内容<br>スレッドの属性|仮想アドレス空間<br>大域変数<br>開いたファイル<br>タイマー<br>シグナル<br>セマフォ<br>アカウント情報|

（http://www.atdot.net/~ko1/activities/sasada_gt.pdf 表1.1:スレッドとプロセスの基本的な情報 より）


### 1.2.[補足]タスクとスレッドの違い

ぶっちゃけ同じ。扱う実行コンテキストもタスクとスレッドで違わない。

* タスクもスレッドも同じ粒度の実行コンテキストを持つ
    * 実行可能状態(RUNNING/READY/...など),優先度なども同じ
* タスクはRTOSにおける用語。スレッドはマルチプロセスOSにおける用語
* 「親」が異なる
    * **タスクの親**：OS。プロセス/仮想アドレスという概念が(大抵)ないため
        * OS∋タスク の関係
    * **スレッドの親**：プロセス。
        * OS∋プロセス∋スレッド の関係
    * RTOSでは１システム１プログラムなので、システム上でタスクが直接動く

タスクとスレッドが違うのではなく、扱うOSにおけるタスク/スレッドの位置づけが違うという認識でOK。あるいは以下の関係で捉えてもよい。

* タスク ≒ カーネルレベルスレッド
* スレッド ≒ ユーザーレベルスレッド

・・・タスクだと生成時にどういう設定でシステムリソースを消費するか等を、制限の多い環境下で細かく指定しないといけないので、調整がスレッドに比べて大変（調整相手に人間も加わってくるなど）。

## 2.C++でのスレッド


